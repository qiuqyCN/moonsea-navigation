<!-- 修改密码模态框 -->
<div th:fragment="change-password-modal">
    <div id="changePasswordModal" class="modal">
        <div class="modal-box w-11/12 max-w-md">
            <h3 class="font-bold text-lg mb-4">修改密码</h3>
            <form id="changePasswordForm" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">当前密码</span>
                    </label>
                    <input type="password" id="currentPassword" name="currentPassword" placeholder="请输入当前密码" class="input input-bordered w-full" required />
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">新密码</span>
                    </label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="请输入新密码" class="input input-bordered w-full" required minlength="6" />
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">确认新密码</span>
                    </label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" placeholder="请再次输入新密码" class="input input-bordered w-full" required />
                </div>

                <div class="modal-action mt-6">
                    <button type="button" class="btn btn-ghost" onclick="closeChangePasswordModal()">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="loading loading-spinner loading-xs" id="changePasswordLoadingSpinner" style="display: none;"></span>
                        <span id="changePasswordButtonText">修改密码</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('modal-open');
            // 重置表单
            document.getElementById('changePasswordForm').reset();
            // 重置错误状态
            const inputs = document.querySelectorAll('#changePasswordForm input');
            inputs.forEach(input => {
                input.classList.remove('input-error');
            });
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('modal-open');
        }

        // 表单提交事件
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                currentPassword: formData.get('currentPassword'),
                newPassword: formData.get('newPassword'),
                confirmNewPassword: formData.get('confirmNewPassword')
            };

            const button = this.querySelector('button[type="submit"]');
            const loadingSpinner = document.getElementById('changePasswordLoadingSpinner');
            const buttonText = document.getElementById('changePasswordButtonText');

            // 显示加载状态
            button.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            buttonText.textContent = '修改中...';

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.text();

                if (result === 'success') {
                    alert('密码修改成功！');
                    closeChangePasswordModal();
                } else {
                    alert('修改失败：' + result);

                    // 高亮错误字段
                    if (result.includes('当前密码不正确')) {
                        document.getElementById('currentPassword').classList.add('input-error');
                    }
                    if (result.includes('新密码和确认密码不一致')) {
                        document.getElementById('newPassword').classList.add('input-error');
                        document.getElementById('confirmNewPassword').classList.add('input-error');
                    }
                }
            } catch (error) {
                alert('网络错误，请稍后重试');
            } finally {
                // 恢复按钮状态
                button.disabled = false;
                loadingSpinner.style.display = 'none';
                buttonText.textContent = '修改密码';
            }
        });

        // 关闭模态框事件 - 点击模态框外部区域
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('changePasswordModal');
            if (event.target === modal) {
                closeChangePasswordModal();
            }
        });

        // 监听输入框，移除错误状态
        const inputs = document.querySelectorAll('#changePasswordForm input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('input-error');
            });
        });
    </script>
</div>
